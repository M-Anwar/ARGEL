<!DOCTYPE html>
<html>
<head>
    <!-- This main.html does not nees all the javascripts and css stylings of the other pages, bootstrap and jquery is enough
    to achieve the visual styling. If later you wish you add different looks or behaviours, add them ONE BY ONE here. On slow 
    platforms, the loading time of the scripts is significant so lets keep the imports optimized. 
    -->
    <title>ARGEL Marketing Solutions</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/argel.css">
    <link rel="stylesheet" href="css/simple-sidebar.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>   
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body onload="init();">   
	
	<section class="mbr-box mbr-section mbr-section--relative mbr-section--fixed-size mbr-section--full-height mbr-section--bg-adapted mbr-parallax-background mbr-after-navbar" id="header1-73" >
    
    <div id="wrapper">
        <!-- Sidebar -->
		
        <div id="sidebar-wrapper" >
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="#">
                        Menu
                    </a>
                </li>             
                <li>
                    <canvas id="photo" width="210" height="161" style="background: #0077FF;"></canvas>
                </li>
                <li style= "padding-bottom:5px">                    
					<button onclick="takePhoto();" class="btn btn-primary btn-block" >Begin Capture</button>
				</li>
				<li>
                    <button data-toggle="collapse" data-target="#uploadPic"  class="btn btn-primary btn-block">Choose Photo</button>
                    <form id="uploadPic" action="" method="post" enctype="multipart/form-data" class = "form-group collapse">
                        <input type="file" name="crowdPic" id ="crowdPic" class = "form-control"/>       
                        <input class = "btn btn-success" type="submit" value="Upload!" id ="upload"/>
                    </form>
                </li>        
                <li>
                    <a href="#"> IP Camera (MJPEG Only) </a>                                   
                    <input type="text" class="form-control" value="http://192.168.2.15:8080/video" id="ipCamAddress">                 
                    <input type="button" id = "ipcamera" class="btn btn-primary col-lg-6" value="Switch to IP" onclick="setupIPCamera();">   
                    <input type="button" id = "webcamera" class="btn btn-primary col-lg-6" value="Switch to Local" onclick="setupWebcam();">   
                </li>
                <li>
                    <a href="#"> Server Address </a>                                   
                    <input type="text" class="form-control" value="" id="serverAddress" >                             
                </li>
                <li>
                    <a href="#" data-toggle="collapse" data-target="#dataRecorderDiv"> Data Recorder </a>                    
                    <div id= "dataRecorderDiv" class ="collapse">
                        <select class="form-control" id = "timeSelection">
                            <option value="1000">1 Second</option>
                            <option value="2000">2 Seconds</option>
                            <option value="5000">5 Seconds</option>
                            <option value="7000">7 Seconds</option>
                            <option value="10000">10 Seconds</option>
                            <option value="15000">15 Seconds</option>
                        </select>  
                        <button class="btn btn-primary" id = "btnRecord" onclick = "record()">Record</button>
                    </div>
                    
                </li>
            </ul>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
		   
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-12" style="display:none" id = "videoDisplay">
                        <video class= "display" id = "display" src="" width = "720" height ="480" controls autoplay = "true" </video>                          
                    </div>
                    <div class ="col-lg-12" style = "display:block" id = "imageDisplay">
                        <img class="display" id = "displayImg" src="assets\images\TargettingAdvertising2.png"></img>                            
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <a class="btn btn-default" id="menu-toggle">Show Menu</a>
                        <a class="btn btn-default" id="refresh">Refresh Page</a>
                        <button class="btn btn-default" onclick="toggleFeed();";>View Video Feed</button>
						<a class="btn btn-default" href="index.html">Back</a>
                        
                        <!-- Debug Tools -->
                        <button data-toggle="collapse" data-target="#pythonDebug" class="btn btn-primary">Debug Ouput</button>						
                        <button data-toggle="collapse" data-target="#debugMenu" class="btn btn-primary">Debug Tools</button>
                        
                        <p id="timestats">0:00 - 0:00</p>                        
                    </div>
                </div>
                
                <div class = "row">
                    <div class="col-lg-12">                        
                        <video style="display:none" id="camFeed" autoplay></video>                        
                        <img style = "display:none" id="ipcamFeed" src=""></img>                        
                    </div>
                </div>
                <div class = "row collapse" id ="pythonDebug" style = "white-space:pre"> </div>
            </div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>          
	</section>
        

    
    <script>
        var defaultAddress = "http://localhost:3000";
        var fetchAd = "/api/fetchad";
        var viewAd = "/view/";   
		// stores the advertisement which is currently being displayed
		var currAd=null;
		var currAdURI=null;
		var imgDisplayTime=10000;
		
        
        var ipcam = false;
        var interval;
        var recording = false;
		var dataJSONlocal={ "position" :{
													"lon": null,
													"lat": null
												},
							"Weather":{
								"main": null,
								"temp": null
							}
	    }
		
		
		var weatherUpdateInterval=600000; // variable controls how often weather information is updated
        // set weather interval
		weatherInterval=setInterval(function(){weatherReport()},weatherUpdateInterval);
	
		
		
		// The following function updates weather parameters
		function weatherReport(){
			var weatherData;
			$.ajax({ // create an AJAX call...     
						dataType: "JSON",
						contentType: false, 
						method:"GET",		
						url: "http://api.openweathermap.org/data/2.5/weather?lat="+dataJSONlocal.position.lat+"&lon="+dataJSONlocal.position.lon+"&APPID=51c76b1d6a9852911afc15336113be79" ,
						success: function(data, status) { // on success..   
						   dataJSONlocal.Weather.main=data.weather[0].main;
						   dataJSONlocal.Weather.temp=data.main.temp;
						},
						error: function(xhr, desc, err) { // on success..                    
							console.log(desc);
						}
					});
		}
		
		// The following function updates location information
		function getLocation() {
			$.ajax({ // create an AJAX call...     
						dataType: "JSON",
						contentType: false,   
						method:"GET",		
						url: "https://maps.googleapis.com/maps/api/browserlocation/json?browser=chromium&sensor=false" ,
						success: function(data, status) { // on success.. 
						   dataJSONlocal.position.lat=data.location.lat;
						   dataJSONlocal.position.lon=data.location.lng;
						   weatherReport();
						   //alert(dataJSONlocal.position.lat);
						},
						error: function(xhr, desc, err) { // on success..                    
							console.log(desc);
						}
					});
		}	
        //UI toggles and updates
        $("#refresh").click(function(e){
            if(location)
                location.reload();
        });
        $("#menu-toggle").click(function(e) {
            e.preventDefault();
            $("#wrapper").toggleClass("toggled");
        });
        $("#serverAddress").focusout(function(e){
            var uri = $("#serverAddress").val();
            if(uri=="") {               
                $("#serverAddress").val(defaultAddress);
            }
        });

        //Video Statistics and camera
        $(document).ready(function(){
          $("#display").on("timeupdate",function(event){
              onTrackedVideoFrame(this.currentTime, this.duration);
            });
		  $("#display").on( "ended",function(event){
              showAd();
            });
		  $("#display").on( "loadeddata",function(event){
              var interval=this.duration-10;
			  if (interval<0){interval=0;}
			  console.log(interval);
			  setTimeout(function(){takePhoto();},interval*1000);
            });
		  
		  
        });  
        function onTrackedVideoFrame(currentTime, duration){
            $("#timestats").text(currentTime + " - " + duration);
           
        }
        function toggleFeed(){
            if(ipcam ==false){
                $("#camFeed").toggle();
                $("#ipcamFeed").hide();
                
            }else{
                $("#ipcamFeed").toggle();
                $("#camFeed").hide();
            }
        }

        
        function init()
        {
            $("#serverAddress").attr("value",defaultAddress);
            setupWebcam();  
			getLocation();			
				
        }

        //Fullscreen controls
        document.addEventListener("keydown", function(e) {                
                if (e.keyCode == 27) {  //Escape key to quit fullscreen
                  exitFullscreen();
                }
            }, false);
        function exitFullscreen(){
            document.webkitCancelFullScreen();
        }
        function requestFullscreen(displayID){
            var display = document.getElementById(displayID);
            display.webkitRequestFullscreen();
        }
        
        //Webcam INIT
        function setupWebcam(){       
            ipcam = false;
            //toggleFeed();
            if($("#ipcamera").hasClass("btn-danger")){
                $("#ipcamera").removeClass("btn-danger").addClass("btn-primary");
            }
            $("#webcamera").addClass("btn-danger");
            if(navigator.webkitGetUserMedia)
            {
                navigator.webkitGetUserMedia({video:true}, onSuccess, onFail);
            }
            else
            {
                alert('webRTC not available');
            }
            
        }
        function onSuccess(stream)
        {
            $("#camFeed").attr("src",URL.createObjectURL(stream));
        }

        function onFail()
        {
            alert('could not connect stream');
        }

        //IP camera Init
        function setupIPCamera(){
            ipcam = true;
            //toggleFeed();
            if($("#webcamera").hasClass("btn-danger")){
                $("#webcamera").removeClass("btn-danger").addClass("btn-primary");
            }
            $("#ipcamera").addClass("btn-danger");            
            var uri = $("#ipCamAddress").val();
            $("#ipcamFeed").attr("src", uri)
            
           
        }

        //Recording
        function record(){
            var value = parseInt($("#timeSelection").val());
            if(recording==false){
                $("#btnRecord").removeClass("btn-primary").addClass("btn-danger");
                recording = true;
                interval = setInterval(captureAndStoreImage,value);
            }
            else{               
                $("#btnRecord").removeClass("btn-danger").addClass("btn-primary"); 
                recording = false;
                clearInterval(interval);
                alert("Capture Stopped");
            }
        }
        function captureAndStoreImage(){         
            var date = new Date().getTime();            
            
            var fs = require("fs");
            if (!fs.existsSync('captures')){
                fs.mkdirSync('captures');
            }
            if(ipcam==false){
                saveCamToImage('captures/'+date +".jpg");
            }
            else{
                saveIPToImage('captures/'+date +".jpg");
            }
        }

        function saveCamToImage(imageName){
            var c = document.getElementById('photo');
            var v = document.getElementById('camFeed');
            c.getContext('2d').drawImage(v, 0, 0, 210, 161);

            var canvas = document.createElement('canvas');
            canvas.width = $("#camFeed").innerWidth();
            canvas.height = $("#camFeed").innerHeight();
            canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);

            var fs = require("fs");            
            img = canvas.toDataURL('image/jpg');
            var data = img.replace(/^data:image\/\w+;base64,/, "");
            var buf = new Buffer(data, 'base64');
            fs.writeFileSync(imageName, buf);            
            canvas = null;
        }
        function saveIPToImage(imageName){
            var c = document.getElementById('photo');
            var v = document.getElementById('ipcamFeed');
            c.getContext('2d').drawImage(v, 0, 0, 210, 161);

            var canvas = document.createElement('canvas');
            canvas.width = $("#ipcamFeed").width();
            canvas.height = $("#ipcamFeed").height();
            canvas.getContext('2d').drawImage(v,0,0,canvas.width,canvas.height);                

            var fs = require("fs");            
            img = canvas.toDataURL('image/jpg');
            var data = img.replace(/^data:image\/\w+;base64,/, "");
            var buf = new Buffer(data, 'base64');
            fs.writeFileSync(imageName, buf);            
            canvas = null;
        }

        // The following function sets the timer for next takephoto function call		
        //Advertisement Display
        function showAd(){
            var curAdd=currAd;
			var viewAdURI=currAdURI;
            //Copied from server validation - check to see if the ad is an image or video
            try{
                var mime = curAdd.videoad.contentType   
                var video = true;
                if(mime.indexOf("jpeg")> -1 || mime.indexOf("png")>-1){
                    video = false;
                }
                if(video){
                    $('#display').attr('src',viewAdURI+curAdd._id);
                    $('#displayImg').attr('src','');
                    $('#videoDisplay').show();
                    $('#imageDisplay').hide();
                }
                else{
                    $('#displayImg').attr('src',viewAdURI+curAdd._id);
                    $('#display').attr('src','');
                    $('#videoDisplay').hide();
                    $('#imageDisplay').show();  
                    takePhoto();
                    setTimeout(function(){showAd();},imgDisplayTime); 
                }
            }catch(e){
                console.log("There was a problem: " + e);
            }
        }


        //Server calls
        function takePhoto()
        {
            var uri = $("#serverAddress").val();
            if(uri==""){
                uri = defaultAddress;
            }
            var fetchAdURI = uri + fetchAd;
            var viewAdURI = uri + viewAd;
            
            var fileName = 'image.png';
            if(ipcam==false){ //What to do when you are on local camera
                saveCamToImage(fileName);                
            }else{ //if you are using IP camera with MJPEG stream
                saveIPToImage(fileName);
            }

            var request = require("request");
            var path = require('path'); 
            var fs = require("fs"); 
            
            var formData = {
                crowdPic: fs.createReadStream(fileName)
            }
                            
            console.log("Submitting Post Request");
            request.post({url:fetchAdURI, formData: formData, metaData: dataJSONlocal}, function optionalCallback(err, httpResponse, body) {

                if (err) {
                    console.log(err);
                    return console.error('upload failed:', err);
                }
                //console.log('Upload successful!  Server responded with:', body);
				console.log('Fetched a new Ad');
                var jsonBody = JSON.parse(body);                
                //$('#display').attr('src',viewAdURI+jsonBody.bestAd._id);
                console.log(jsonBody.bestAd);
				
				if (currAd==null){
					currAd=jsonBody.bestAd[0];
					currAdURI=viewAdURI;
					showAd();
				}
				else {
					currAd=jsonBody.bestAd[0];
					currAdURI=viewAdURI;
				}
				
                $('#pythonDebug').html(jsonBody.pythonDebug);
                
            });
            
            fs.unlink(fileName, function(err){
                if(err)console.log(err);
            });            
            
        }

        //User Selected upload
        $('#uploadPic').submit(function() { // catch the form's submit event
            
            var uri = $("#serverAddress").val();
            if(uri==""){
                uri = defaultAddress;
            }
            var fetchAdURI = uri + fetchAd;
            var viewAdURI = uri + viewAd;
            
            
           var myFormData = new FormData(this);          
            $.ajax({ // create an AJAX call...     
                dataType: "JSON",
                data: myFormData,
                processData: false,
                contentType: false,                
                type: $(this).attr('method'), // GET or POST
                url: fetchAdURI, // the file to call
                enctype: $(this).attr('enctype'),
                success: function(data, status) { // on success..  
                    showAd(data.bestAd, viewAdURI);
//                    $('#display').attr('src',viewAdURI+data.bestAd._id);                    
                    $('#pythonDebug').html(data.pythonDebug);
                },
                error: function(xhr, desc, err) { // on success..                    
                    console.log(desc);
                }
            });
            return false; // cancel original event to prevent form submitting
        });
    </script>
</body>
</html>